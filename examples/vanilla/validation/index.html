<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FormKeeper - Validation Example</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; padding: 2rem; background: #09090b; color: #fafafa; }
    .container { max-width: 500px; margin: 0 auto; }
    h1 { margin-bottom: 0.5rem; }
    p { color: #a1a1aa; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; }
    input { width: 100%; padding: 0.75rem; border: 1px solid #27272a; border-radius: 0.5rem; background: #18181b; color: #fafafa; }
    input:focus { outline: none; border-color: #3b82f6; }
    input.error { border-color: #ef4444; }
    input.valid { border-color: #22c55e; }
    .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; }
    .hint { color: #a1a1aa; font-size: 0.75rem; margin-top: 0.25rem; }
    button { width: 100%; padding: 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; margin-top: 1rem; }
    button:hover { background: #2563eb; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .password-strength { margin-top: 0.5rem; }
    .strength-bar { height: 4px; background: #27272a; border-radius: 2px; overflow: hidden; }
    .strength-fill { height: 100%; transition: all 0.3s; }
    .strength-weak { width: 33%; background: #ef4444; }
    .strength-medium { width: 66%; background: #f59e0b; }
    .strength-strong { width: 100%; background: #22c55e; }
    .strength-label { font-size: 0.75rem; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Advanced Validation</h1>
    <p>This example demonstrates various validation rules and async validation.</p>

    <form id="signup-form">
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" placeholder="Choose a username">
        <div id="username-error" class="error-message"></div>
        <div class="hint">3-20 characters, letters and numbers only</div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="Enter your email">
        <div id="email-error" class="error-message"></div>
        <div id="email-checking" class="hint" style="display: none;">Checking availability...</div>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" placeholder="Create a password">
        <div id="password-error" class="error-message"></div>
        <div class="password-strength">
          <div class="strength-bar">
            <div id="strength-fill" class="strength-fill"></div>
          </div>
          <div id="strength-label" class="strength-label"></div>
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password">
        <div id="confirmPassword-error" class="error-message"></div>
      </div>

      <div class="form-group">
        <label for="age">Age</label>
        <input type="number" id="age" name="age" placeholder="Enter your age">
        <div id="age-error" class="error-message"></div>
        <div class="hint">Must be 18 or older</div>
      </div>

      <button type="submit" id="submit-btn">Create Account</button>
    </form>
  </div>

  <script type="module">
    import { createForm } from '@oxog/formkeeper'

    // Simulate async email check
    async function checkEmailAvailability(email) {
      await new Promise(resolve => setTimeout(resolve, 1000))
      const takenEmails = ['admin@example.com', 'test@example.com']
      return !takenEmails.includes(email.toLowerCase())
    }

    // Password strength calculator
    function getPasswordStrength(password) {
      let score = 0
      if (password.length >= 8) score++
      if (password.length >= 12) score++
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++
      if (/\d/.test(password)) score++
      if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) score++

      if (score <= 2) return { level: 'weak', label: 'Weak', class: 'strength-weak' }
      if (score <= 4) return { level: 'medium', label: 'Medium', class: 'strength-medium' }
      return { level: 'strong', label: 'Strong', class: 'strength-strong' }
    }

    // Create form instance
    const form = createForm({
      initialValues: {
        username: '',
        email: '',
        password: '',
        confirmPassword: '',
        age: ''
      },
      mode: 'onBlur',
      onSubmit: async (values) => {
        console.log('Form submitted:', values)
        alert('Account created successfully!')
      }
    })

    // Register fields with validation rules
    form.register('username', {
      required: 'Username is required',
      minLength: { value: 3, message: 'Username must be at least 3 characters' },
      maxLength: { value: 20, message: 'Username cannot exceed 20 characters' },
      pattern: {
        value: /^[a-zA-Z0-9]+$/,
        message: 'Username can only contain letters and numbers'
      }
    })

    form.register('email', {
      required: 'Email is required',
      pattern: {
        value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        message: 'Please enter a valid email address'
      },
      validate: async (value) => {
        if (!value) return true
        const emailCheckEl = document.getElementById('email-checking')
        emailCheckEl.style.display = 'block'
        const available = await checkEmailAvailability(value)
        emailCheckEl.style.display = 'none'
        return available || 'This email is already taken'
      }
    })

    form.register('password', {
      required: 'Password is required',
      minLength: { value: 8, message: 'Password must be at least 8 characters' },
      validate: (value) => {
        if (!value) return true
        const strength = getPasswordStrength(value)
        if (strength.level === 'weak') {
          return 'Password is too weak. Add uppercase, numbers, or symbols.'
        }
        return true
      }
    })

    form.register('confirmPassword', {
      required: 'Please confirm your password',
      validate: (value, formValues) => {
        return value === formValues.password || 'Passwords do not match'
      },
      deps: ['password']
    })

    form.register('age', {
      required: 'Age is required',
      min: { value: 18, message: 'You must be at least 18 years old' },
      max: { value: 120, message: 'Please enter a valid age' }
    })

    // Get DOM elements
    const fields = ['username', 'email', 'password', 'confirmPassword', 'age']

    fields.forEach(field => {
      const input = document.getElementById(field)

      input.addEventListener('input', (e) => {
        form.setValue(field, e.target.value, { shouldValidate: true })
        updateUI()

        // Update password strength indicator
        if (field === 'password') {
          updatePasswordStrength(e.target.value)
        }
      })

      input.addEventListener('blur', () => {
        form.setTouched(field, true)
        updateUI()
      })
    })

    // Handle form submit
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault()
      await form.handleSubmit(e)
      updateUI()
    })

    // Update password strength indicator
    function updatePasswordStrength(password) {
      const fillEl = document.getElementById('strength-fill')
      const labelEl = document.getElementById('strength-label')

      if (!password) {
        fillEl.className = 'strength-fill'
        labelEl.textContent = ''
        return
      }

      const strength = getPasswordStrength(password)
      fillEl.className = `strength-fill ${strength.class}`
      labelEl.textContent = strength.label
    }

    // Update UI based on form state
    function updateUI() {
      fields.forEach(field => {
        const input = document.getElementById(field)
        const errorEl = document.getElementById(`${field}-error`)
        const error = form.getError(field)
        const isTouched = form.isTouched(field)

        input.classList.remove('error', 'valid')

        if (isTouched) {
          if (error) {
            input.classList.add('error')
            errorEl.textContent = error
          } else if (input.value) {
            input.classList.add('valid')
            errorEl.textContent = ''
          } else {
            errorEl.textContent = ''
          }
        } else {
          errorEl.textContent = ''
        }
      })

      const submitBtn = document.getElementById('submit-btn')
      submitBtn.disabled = form.isSubmitting() || form.isValidating()
      submitBtn.textContent = form.isSubmitting() ? 'Creating Account...' : 'Create Account'
    }
  </script>
</body>
</html>
